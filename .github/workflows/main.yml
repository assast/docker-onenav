name: Docker Image å‘å¸ƒåˆ° GHCR

on:
  push:
    # ä»…åœ¨æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘æ„å»ºå’Œæ¨é€
    branches: [ "main" ]

  # ä¹Ÿæ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼Œæ–¹ä¾¿æµ‹è¯•
  workflow_dispatch:

jobs:
  build_and_push_ghcr:
    runs-on: ubuntu-latest

    # ã€é‡è¦é…ç½®ã€‘è®¾ç½®æƒé™ï¼šè¯»å–ä»£ç ï¼Œå†™å…¥ GitHub Packages (GHCR)
    permissions:
      contents: read
      packages: write

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç  (Checkout repository)
        uses: actions/checkout@v4

      # --- 1. è®¾ç½®æ„å»ºç¯å¢ƒ ---
      - name: ğŸ› ï¸ è®¾ç½® Docker Buildx (æ”¯æŒå¤šå¹³å°æ„å»ºå’Œç¼“å­˜)
        uses: docker/setup-buildx-action@v3

      # --- 2. ç™»å½•åˆ° GHCR ---
      - name: ğŸ”‘ ç™»å½•åˆ° GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          # ä½¿ç”¨ GitHub æä¾›çš„å†…ç½® Token
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # --- 3. å®šä¹‰æ ‡ç­¾å’Œå…ƒæ•°æ® ---
      - name: ğŸ·ï¸ æå– Docker å…ƒæ•°æ® (æ ‡ç­¾, æ ‡ç­¾)
        id: meta
        uses: docker/metadata-action@v5
        with:
          # é•œåƒåç§°æ ¼å¼ï¼šghcr.io/ç”¨æˆ·å/ä»“åº“å
          images: ghcr.io/${{ github.repository }}
          tags: |
            # ä½¿ç”¨ git commit çš„é•¿ SHA ä½œä¸ºå”¯ä¸€æ ‡ç­¾
            type=sha,format=long,prefix=
            # å¦‚æœæ˜¯ main åˆ†æ”¯ï¼Œæ·»åŠ  latest æ ‡ç­¾
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      # --- 4. æ„å»ºå¹¶æ¨é€ ---
      - name: ğŸ“¦ æ„å»ºå¹¶æ¨é€ Docker é•œåƒåˆ° GHCR
        # ã€å…³é”®ä¿®æ­£ã€‘è¿™é‡Œç§»é™¤äº† '-and-'ï¼šä½¿ç”¨ docker/build-push-action
        uses: docker/build-push-action@v5
        with:
          # ä¸Šä¸‹æ–‡è·¯å¾„ï¼Œé»˜è®¤ä¸ºä»“åº“æ ¹ç›®å½•
          context: .
          # Dockerfile æ–‡ä»¶è·¯å¾„ï¼Œé»˜è®¤ä¸º ./Dockerfile
          file: ./Dockerfile
          # å¼€å¯æ¨é€
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # å¼€å¯æ„å»ºç¼“å­˜ï¼ŒåŠ é€Ÿåç»­æ„å»º
          cache-from: type=gha
          cache-to: type=gha,mode=max