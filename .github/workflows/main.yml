name: Docker é•œåƒ CI/CD (æ¨é€åˆ° GHCR)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build_and_push_ghcr:
    runs-on: ubuntu-latest

    # å¯ç”¨æƒé™ï¼šcontents: read ç”¨äºä»£ç æ£€å‡ºï¼Œpackages: write ç”¨äºæ¨é€é•œåƒåˆ° GHCR
    permissions:
      contents: read
      packages: write

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç  (Checkout repository)
        uses: actions/checkout@v4

      # --- ğŸ› ï¸ è®¾ç½® Docker Buildx ---
      - name: ğŸ› ï¸ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      # --- ğŸ”‘ ç™»å½•åˆ° GitHub Container Registry (GHCR) ---
      - name: ğŸ”‘ ç™»å½•åˆ° GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          # ä½¿ç”¨å†…ç½®çš„ GITHUB_TOKEN ä½œä¸ºå¯†ç 
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # --- ğŸ·ï¸ å®šä¹‰é•œåƒæ ‡ç­¾å’Œå…ƒæ•°æ® ---
      - name: ğŸ·ï¸ æå– Docker å…ƒæ•°æ® (æ ‡ç­¾, æ ‡ç­¾)
        id: meta
        uses: docker/metadata-action@v5
        with:
          # æ ¼å¼ä¸º ghcr.io/ç”¨æˆ·å/ä»“åº“å
          images: ghcr.io/${{ github.repository }}
          tags: |
            # é»˜è®¤æ ‡ç­¾ï¼šä½¿ç”¨ git commit çš„é•¿ SHA
            type=sha,format=long,prefix=
            # å¦‚æœæ˜¯ main åˆ†æ”¯ï¼Œæ·»åŠ  latest æ ‡ç­¾
            type=raw,value=latest,enable={{ github.ref == 'refs/heads/main' }}

      # --- ğŸ“¦ æ„å»ºå¹¶æ¨é€é•œåƒ ---
      - name: ğŸ“¦ æ„å»ºå¹¶æ¨é€ Docker é•œåƒåˆ° GHCR
        uses: docker/build-and-push-action@v5
        with:
          context: .
          file: ./Dockerfile # ç¡®ä¿æ‚¨çš„ Dockerfile åœ¨æ ¹ç›®å½•ä¸‹
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha # å¼€å¯ GitHub Actions ç¼“å­˜
          cache-to: type=gha,mode=max